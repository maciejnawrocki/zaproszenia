<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Potwierdzenie obecnoÅ›ci na weselu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('../resources/wallpaper.webp');
            background-size: 400px auto;
            background-repeat: repeat;      /* kafelkowanie w obu osiach */
            background-position: top left;  /* opcjonalnie: punkt startowy */
        }
        h1, h2 { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
<nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <a href="/" class="text-xl font-bold text-gray-800 hover:text-gray-600 transition duration-300">
                    ðŸŽŠ Strona gÅ‚Ã³wna
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="flex items-center justify-center min-h-[calc(100vh-4rem)]">
    <div id="main-container" class="w-full max-w-lg mx-auto bg-white p-8 sm:p-12 rounded-xl shadow-lg text-center">

    <!-- Loader, widoczny na poczÄ…tku -->
        <div id="loader">
            <h2 class="text-2xl font-bold text-gray-700">WczytujÄ™ Twoje zaproszenie...</h2>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto mt-6"></div>
        </div>

    <!-- Formularz RSVP, poczÄ…tkowo ukryty -->
        <div id="rsvp-form" class="hidden">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Serdecznie zapraszamy!</h1>
            <p class="mt-4 text-lg text-gray-600">Cieszymy siÄ™, Å¼e moÅ¼emy CiÄ™ zaprosiÄ‡ na nasz Å›lub.</p>
            <div class="mt-8 mb-8 p-4 bg-rose-50 border border-rose-200 rounded-lg">
                <p class="text-xl font-semibold text-rose-800" id="guest-name">ImiÄ™ i nazwisko goÅ›cia</p>
            </div>

            <p class="text-gray-700 mb-6">Prosimy o potwierdzenie swojej obecnoÅ›ci:</p>

            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="sendRsvp('Tak, bÄ™dÄ™!')" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300">
                    BÄ™dÄ™ na pewno!
                </button>
                <button onclick="sendRsvp('Niestety, nie mogÄ™')" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300">
                    Nie dam rady
                </button>
            </div>
            <p id="current-status" class="mt-4 text-sm text-gray-500"></p>
        </div>

    <!-- Komunikat o sukcesie/bÅ‚Ä™dzie, poczÄ…tkowo ukryty -->
        <div id="message-container" class="hidden">
            <h2 id="message-title" class="text-2xl font-bold"></h2>
            <p id="message-text" class="mt-2 text-gray-600"></p>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxrLB19b-pO1O4pt0ZTHjUX805SmPHhb1OP3i_06GSEXTVzXTXxTcMyei6RT0lJa0s/exec';

    const loader = document.getElementById('loader');
    const rsvpForm = document.getElementById('rsvp-form');
    const messageContainer = document.getElementById('message-container');
    const messageTitle = document.getElementById('message-title');
    const messageText = document.getElementById('message-text');
    const guestNameEl = document.getElementById('guest-name');
    const currentStatusEl = document.getElementById('current-status');

    function showMessage(title, text, isError = false) {
      loader.classList.add('hidden');
      rsvpForm.classList.add('hidden');
      messageContainer.classList.remove('hidden');
      messageTitle.textContent = title;
      messageText.textContent = text;
      messageTitle.className = isError ? 'text-2xl font-bold text-red-600' : 'text-2xl font-bold text-green-600';
    }

    window.onload = async () => {
      const params = new URLSearchParams(window.location.search);
      const guestId = params.get('id');

      if (!guestId) {
        showMessage('BÅ‚Ä…d', 'Nie znaleziono identyfikatora goÅ›cia w adresie URL.', true);
        return;
      }

      if (!SCRIPT_URL || SCRIPT_URL === 'TUTAJ_WKLEJ_URL_DO_WEB_APP') {
        showMessage('BÅ‚Ä…d Konfiguracji', 'ProszÄ™ skonfigurowaÄ‡ adres URL skryptu w pliku HTML.', true);
        return;
      }

      try {
        const response = await fetch(`${SCRIPT_URL}?id=${guestId}`);
        const result = await response.json();

        if (result.status === 'success') {
          const guest = result.data;
          guestNameEl.textContent = `${guest.firstName} ${guest.lastName}`;
          if (guest.confirmation) {
            currentStatusEl.textContent = `Twoja obecna odpowiedÅº: ${guest.confirmation}`;
          }

                // Pokazujemy formularz, ukrywamy loader
          loader.classList.add('hidden');
          rsvpForm.classList.remove('hidden');
        } else {
          showMessage('BÅ‚Ä…d', result.message, true);
        }
      } catch (error) {
        showMessage('BÅ‚Ä…d sieci', 'Nie moÅ¼na poÅ‚Ä…czyÄ‡ siÄ™ z serwerem. SprawdÅº poÅ‚Ä…czenie z internetem.', true);
      }
    };

    // Funkcja do wysyÅ‚ania odpowiedzi RSVP
    async function sendRsvp(attendingStatus) {
      const params = new URLSearchParams(window.location.search);
      const guestId = params.get('id');

        // PokaÅ¼ loader podczas wysyÅ‚ania
      loader.classList.remove('hidden');
      rsvpForm.classList.add('hidden');

      try {
            // WywoÅ‚anie POST do skryptu
            const response = await fetch(SCRIPT_URL, {
          method: 'POST',
                mode: 'no-cors', // WaÅ¼ne przy prostych POST do Google Scripts
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: guestId,
                    attending: attendingStatus,
                }),
        });

            // Ze wzglÄ™du na 'no-cors', nie moÅ¼emy odczytaÄ‡ odpowiedzi,
            // wiÄ™c zakÅ‚adamy sukces i po prostu pokazujemy komunikat.
            // Google Apps Script wykona swoje zadanie po stronie serwera.
        showMessage('DziÄ™kujemy!', 'Twoja odpowiedÅº zostaÅ‚a zapisana. Do zobaczenia!');
      } catch (error) {
            // Ten blok moÅ¼e siÄ™ nie wykonaÄ‡ przy 'no-cors', ale zostawiamy na wszelki wypadek
        showMessage('BÅ‚Ä…d', 'WystÄ…piÅ‚ nieoczekiwany bÅ‚Ä…d podczas wysyÅ‚ania odpowiedzi.', true);
      }
    }
</script>
</body>
</html>

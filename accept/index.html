<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Potwierdzenie obecności - Klaudia & Maciej</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Import fontów zgodnych z index.html -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Cormorant+Garamond:ital,wght@0,400;1,400;1,600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gold: #D4AF37;
            --main-green: #83977C;
        }

        body {
            font-family: 'Cormorant Garamond', serif;
            color: var(--main-green);
            background-color: #fdfbf7;
            background-image: url('../resources/wallpaper.webp');
            background-size: 400px auto;
            background-repeat: repeat;
            overflow-x: hidden;
            font-size: 18px;
        }

        .header-font {
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        .italic-text {
            font-family: 'Cormorant Garamond', serif;
            font-style: italic;
            font-size: 1.3rem;
        }

        h1, h2, h3 { font-family: 'Cinzel', serif; }

        /* Styl przycisków */
        .btn-primary {
            background-color: var(--main-green);
            color: white;
            border: 1px solid var(--main-green);
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: white;
            color: var(--main-green);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--main-green);
            border: 1px solid var(--main-green);
            font-family: 'Cinzel', serif;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .btn-outline:hover {
            background-color: var(--main-green);
            color: white;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Nawigacja -->
<nav class="bg-white/95 backdrop-blur-md shadow-sm py-2 border-b border-gray-100 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 flex justify-center items-center">
        <a href="/" class="block home-link">
            <img src="../resources/logo_klaudia_maciej3.png" alt="Klaudia & Maciej" class="h-16 w-auto object-contain">
        </a>
    </div>
</nav>

<div class="flex-grow flex items-center justify-center py-12 px-4">
    <div id="main-container" class="w-full max-w-lg mx-auto bg-white p-8 sm:p-12 rounded-[2rem] shadow-xl text-center border border-[#83977C]/10">

        <!-- Loader -->
        <div id="loader">
            <h2 class="text-2xl header-font text-[#83977C] mb-4">Wczytuję zaproszenie...</h2>
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#83977C] mx-auto"></div>
        </div>

        <!-- Formularz RSVP -->
        <div id="rsvp-form" class="hidden">
            <p class="italic-text text-[#D4AF37] text-2xl mb-2">Witamy!</p>
            <h1 class="text-3xl header-font text-[#83977C] mb-6">Potwierdzenie obecności</h1>

            <div class="my-8 p-6 bg-[#faf9f6] border border-[#83977C]/20 rounded-lg">
                <p class="text-sm uppercase tracking-widest text-[#83977C]/70 mb-2">Twój Gość</p>
                <p class="text-2xl font-bold text-[#83977C] header-font" id="guest-name">...</p>
            </div>

            <div class="text-left space-y-6 mb-8">
                <div>
                    <label for="diet" class="block font-bold text-[#83977C] header-font text-xs mb-2">Preferencje żywieniowe</label>
                    <textarea id="diet" name="diet" class="w-full border border-[#83977C]/30 rounded-lg p-3 focus:outline-none focus:border-[#83977C] bg-[#faf9f6] text-[#83977C]" rows="3" placeholder="np. wegetariańska, bez laktozy, alergie"></textarea>
                </div>

                <div class="space-y-3">
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input id="overnight" name="overnight" type="checkbox" class="h-5 w-5 accent-[#83977C] border-gray-300 rounded">
                        <span class="italic-text text-[#83977C] text-lg group-hover:text-[#6a7a63] transition">Chcę nocować po weselu</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer group">
                        <input id="afterparty" name="afterparty" type="checkbox" class="h-5 w-5 accent-[#83977C] border-gray-300 rounded">
                        <span class="italic-text text-[#83977C] text-lg group-hover:text-[#6a7a63] transition">Zostaję na poprawiny</span>
                    </label>
                </div>
            </div>

            <div class="flex flex-col gap-4 justify-center">
                <button onclick="sendRsvp('Tak, będę!')" class="btn-primary py-3 px-8 rounded-full text-sm font-bold uppercase tracking-widest shadow-md">
                    Potwierdzam przybycie
                </button>
                <button onclick="sendRsvp('Niestety, nie mogę')" class="btn-outline py-3 px-8 rounded-full text-sm font-bold uppercase tracking-widest">
                    Niestety nie mogę
                </button>
            </div>

            <p id="current-status" class="mt-6 text-sm italic text-[#83977C]/70"></p>
        </div>

        <!-- Komunikat o sukcesie/błędzie -->
        <div id="message-container" class="hidden space-y-4">
            <h2 id="message-title" class="text-3xl header-font mb-4"></h2>
            <p id="message-text" class="italic-text text-xl text-[#83977C] leading-relaxed"></p>

            <div class="pt-8">
                <a href="/" class="inline-block btn-outline py-3 px-8 rounded-full text-xs font-bold uppercase tracking-widest no-underline home-link">
                    Powrót do strony głównej
                </a>
            </div>
        </div>

        <!-- Przycisk powrotu (widoczny w formularzu) -->
        <div id="back-btn-container" class="mt-12 pt-6 border-t border-gray-100 hidden">
            <a href="/" class="text-xs font-bold uppercase tracking-widest text-[#83977C]/60 hover:text-[#83977C] transition no-underline pb-1 border-b border-transparent hover:border-[#83977C] home-link">
                &larr; Wróć do strony głównej
            </a>
        </div>

    </div>
</div>

<footer class="bg-[#83977C] text-white py-6 text-center mt-auto">
    <p class="text-xs opacity-70 header-font">Klaudia & Maciej &copy; 2026</p>
</footer>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyuk4-q7axiFZOyXNEH0RwjlsjgztoRu9iCeHk43YC_6aDQ78bkgKatiPhbId9nROA/exec';

    const loader = document.getElementById('loader');
    const rsvpForm = document.getElementById('rsvp-form');
    const messageContainer = document.getElementById('message-container');
    const messageTitle = document.getElementById('message-title');
    const messageText = document.getElementById('message-text');
    const guestNameEl = document.getElementById('guest-name');
    const currentStatusEl = document.getElementById('current-status');
    const dietEl = document.getElementById('diet');
    const overnightEl = document.getElementById('overnight');
    const afterpartyEl = document.getElementById('afterparty');
    const backBtnContainer = document.getElementById('back-btn-container');

    // Funkcja aktualizująca linki powrotne
    function updateHomeLinks(guestId) {
        if (!guestId) return;
        const homeLinks = document.querySelectorAll('.home-link');
        homeLinks.forEach(link => {
            // Dodajemy parametr id do linku, zachowując ewentualne inne parametry (jeśli by były, choć w href="/" raczej ich nie ma)
            // Proste podejście:
            link.href = `/?id=${guestId}`;
        });
    }

    function showMessage(title, text, isError = false) {
      loader.classList.add('hidden');
      rsvpForm.classList.add('hidden');
      backBtnContainer.classList.add('hidden');
      messageContainer.classList.remove('hidden');

      messageTitle.textContent = title;
      messageText.textContent = text;
      messageTitle.className = isError
        ? 'text-3xl header-font text-red-800 mb-4'
        : 'text-3xl header-font text-[#83977C] mb-4';
    }

    window.onload = async () => {
      const params = new URLSearchParams(window.location.search);
      const guestId = params.get('id');

      // Zaktualizuj linki powrotne od razu, jeśli mamy ID
      updateHomeLinks(guestId);

      if (!guestId) {
        showMessage('Błąd', 'Nie znaleziono identyfikatora gościa w adresie URL.', true);
        return;
      }

      if (!SCRIPT_URL) {
        showMessage('Błąd Konfiguracji', 'Proszę skonfigurować adres URL skryptu.', true);
        return;
      }

      try {
        const response = await fetch(`${SCRIPT_URL}?id=${guestId}`);
        const result = await response.json();

        if (result.status === 'success') {
          const guest = result.guestData;

          guestNameEl.textContent = guest.name;

          if (guest.confirmation) currentStatusEl.textContent = `Twoja obecna odpowiedź: ${guest.confirmation}`;
          if (guest.diet) dietEl.value = guest.diet;
          if (guest.overnight) overnightEl.checked = String(guest.overnight).toLowerCase() === 'tak';
          if (guest.afterparty) afterpartyEl.checked = String(guest.afterparty).toLowerCase() === 'tak';

          loader.classList.add('hidden');
          rsvpForm.classList.remove('hidden');
          backBtnContainer.classList.remove('hidden');
        } else {
          showMessage('Ups...', result.message, true);
        }
      } catch (error) {
        showMessage('Błąd sieci', 'Nie można połączyć się z serwerem. Sprawdź połączenie z internetem.', true);
      }
    };

    async function sendRsvp(chosen) {
      const params = new URLSearchParams(window.location.search);
      const guestId = params.get('id');

      loader.classList.remove('hidden');
      rsvpForm.classList.add('hidden');
      backBtnContainer.classList.add('hidden');

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: guestId,
                    confirmation: chosen,
                    diet: dietEl.value.trim(),
                    overnight: overnightEl.checked ? 'Tak' : 'Nie',
                    afterparty: afterpartyEl.checked ? 'Tak' : 'Nie'
                }),
        });
        showMessage('Dziękujemy!', 'Twoja odpowiedź została pomyślnie zapisana. Czekamy na Ciebie!');
      } catch (error) {
        showMessage('Błąd', 'Wystąpił nieoczekiwany błąd podczas wysyłania odpowiedzi.', true);
      }
    }
</script>
</body>
</html>
